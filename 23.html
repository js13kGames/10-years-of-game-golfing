<canvas id=frameCanvas width=256 height=240></canvas>
<button><label for=fileInput>Browse...</label></button>
<script>
A=X=Y=S=0,PC=32768,P=36,s=m=a=p=c=0,r=a=>(c++,memory_read(a)),w=(a,r)=>(c++,memory_write(a,r)),F=a=>(Z=(a&=255)<1,N=a>>7,a),f=a=>(C=1&a,Z=a>>1&1,I=a>>2&1,D=a>>3&1,B=a>>4&1,V=a>>6&1,N=a>>7),f(P=36),h=a=>(w(256+S--,a),S&=255),g=a=>r(256+(S=255&S+1)),O=[...Array(255)].map(((a,r)=>Function("c--,PC++;a=a+p-256*(p>>7),PC++;a=r(p+X&255)+256*r(p+X+1&255),PC++,c++;a=r(p)+256*r(p+1&255)+Y,c+=a-Y>>8<a>>8||o>>4==9,PC++;a=r(a)+X&255,PC++;a=r(a)+Y&255,PC++;a=p,PC++;a=p+256*r(PC+=2);t=p+256*r(PC+=2),c+=t>>8<t+Y>>8||o>>4==9,a=t+Y;t=p+256*r(PC+=2),c+=t>>8<t+X>>8||o>>4==9||(15&o)>13,a=t+X".split(";")["020666Z0Z77713Z444Z8Z999720666Z0Z77713Z444Z8Z999Z20666Z0Z77713Z444Z8Z999Z20666Z0Z77713Z444Z8Z999020666Z0Z77713Z445Z8Z998020666Z0Z77713Z445Z8Z998020666Z0Z77713Z444Z8Z999020666Z0Z77713Z444Z8Z999"[r-(r>>2)]]+";"+"S=X;p=r(a),C=X-p>=0,F(X-p);p=r(a),C=Y-p>=0,F(Y-p);p=r(a),C=p>>7,w(a,F(2*p)),c++;C=A>>7,A=F(2*A+(1&P));p=r(a),C=p>>7,w(a,F(2*p+(1&P))),c++;C=1&A,A=F(A>>1);p=r(a),C=1&p,w(a,F(p>>1)),c++;X=F(X-1);p=r(a),F(p&A),N=p>>7&1,V=p>>6&1;C=1&A,A=F((A>>1)+128*(1&P));w(a,F(r(a)+1)),c++;X=F(X+1);Y=F(Y-1);Y=F(Y+1);Y=F(r(a));p=r(a),C=1&p,w(a,F((p>>1)+128*(1&P))),c++;C=0;I=1;D=0;I=0;A=F(r(a));A=F(r(a)&A);p=r(a),C=A-p>=0,F(A-p);p=r(a),t=A+C-1-p,V=!!(128&(A^p))&&!!(128&(A^t)),C=t>=0,A=F(t);p=r(a),t=A+C+p,V=!(128&(A^p))&&!!(128&(A^t)),C=t>255,A=F(t);C&&(c+=1+(a>>8!=PC+1>>8),PC=a);N&&(c+=1+(a>>8!=PC+1>>8),PC=a);Z&&(c+=1+(a>>8!=PC+1>>8),PC=a);N||(c+=1+(a>>8!=PC+1>>8),PC=a);V&&(c+=1+(a>>8!=PC+1>>8),PC=a);Z||(c+=1+(a>>8!=PC+1>>8),PC=a);V||(c+=1+(a>>8!=PC+1>>8),PC=a);X=F(r(a));A=F(r(a)^A);w(a,F((r(a)-1)&255)),c++;C=A>>7,A=F(2*A);h(PC>>8),h(255&PC),PC=a-1,c++;C=1;D=1;V=0;A=F(r(a)|A);h(A);h(P|16);A=F(g()),c++;f(g()&239),c++;f(g()),PC=g()+256*g()-1,c++;C||(c+=1+(a>>8!=PC+1>>8),PC=a);op(3,1);Y=F(A);w(a,A);w(a,X);X=F(S);X=F(A);w(a,Y);A=F(Y);A=F(X);PC=g()+256*g(c+=2);PC=a-1;PC=r(a)+256*r(a+1-256*((a&255)==255))-1".split(";")["PI#PI#KIDPI#=I#PI#1IDPI#E6%)6%M6$)6%;6%E6%F6%E6%NB'NB'JB&ZB'@B'NB'4B'NB'Y90Y90L9*[90>90Y90290Y90VRSVRS-zXVRSORSVRSWR VRS/5A/5AQ5U/5A:5A/5AH5T/5A\"7C\"7C.7(\"7C?7C\"7C37C\"7C!8+!8+,8z!8+<8+!8+G8+!8+"[r-(r>>2)].charCodeAt()-32]))),op=(e,t)=>(c=0,m=r(PC),p=r(a=PC+1),e?(e>1||r(8192)>>7)&&(e<3||!I)&&(e-2?(h(PC>>8),h(255&PC),h(t?16|P:239&P)):S=S-3&255,I=1,PC=r(65528+2*e)+256*r(65528+2*e+1)):(m&&O[m](),PC++,PC&=65535),P=C+2*Z+4*I+8*D+16*B+32+64*V+128*N);var e=function(){this.state=new Array(8);for(var a=0;a<this.state.length;a++)this.state[a]=64};joy1StrobeState=0,joy2StrobeState=0,e.BUTTON_A=0,e.BUTTON_B=1,e.BUTTON_SELECT=2,e.BUTTON_START=3,e.BUTTON_UP=4,e.BUTTON_DOWN=5,e.BUTTON_LEFT=6,e.BUTTON_RIGHT=7,e.prototype={keydown:function(a){this.state[a]=65},keyup:function(a){this.state[a]=64}},joy1Read=function(){var a;switch(joy1StrobeState){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a=fa.controllers[1].state[joy1StrobeState];break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:default:a=0;break;case 19:a=1}return joy1StrobeState++,24===joy1StrobeState&&(joy1StrobeState=0),a},joy2Read=function(){var a;switch(joy2StrobeState){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a=fa.controllers[2].state[joy2StrobeState];break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:default:a=0;break;case 19:a=1}return joy2StrobeState++,24===joy2StrobeState&&(joy2StrobeState=0),a};var t,o,n=()=>{Ba(),Ba(),Ba()};fa.load=()=>{fa.mapper?2==fa.mapper?(fa.prg_0_bank=0,fa.prg_1_bank=fa.prg.length-1,fa.chr_bank=0):30==fa.mapper?(fa.chr=[[],[],[],[]],fa.prg_0_bank=0,fa.prg_1_bank=fa.prg.length-1,fa.chr_bank=0,fa.mirroring_backup=fa.mirroring):alert("unknown mapper: "+fa.mapper):(fa.prg_0_bank=0,fa.prg_1_bank=fa.prg.length-1,fa.chr_bank=0)},mapper_write=(a,r)=>{30==fa.mapper&&a>=49152&&(fa.prg_0_bank=69905&r,fa.chr_bank=r>>5&3,fa.mirroring=r>>7?3:fa.mirroring_backup),2==fa.mapper&&a>=32768&&(fa.prg_0_bank=4369&r)},memory_read=a=>{if((a&=65535)<8192)a&=2047;else if(a<16384){if(8194==(a&=8199))return Ca();if(8196==a)return ia();if(8199==a)return _a()}else if(a<16416){if(16405==a)return APU.readReg(a);if(16406==a)return joy1Read();if(16407==a)return joy2Read()}else{if(a>=32768&&a<49152)return fa.prg[fa.prg_0_bank][a-32768];if(a>=49152)return fa.prg[fa.prg_1_bank][a-49152]}return t[a]||0},memory_write=(a,r)=>{(a&=65535)<8192?a&=2047:a<16384?8192==(a&=8199)?sa(r):8193==a?ma(r):8195==a?la(r):8196==a?ua(r):8197==a?Pa(r):8198==a?Aa(r):8199==a&&ga(r):a<16404?APU.writeReg(a,r):a<16416?16404==a?ya(r):16405==a?APU.writeReg(a,r):16406==a?(0==(1&r)&&1==(1&joypadLastWrite)&&(joy1StrobeState=0,joy2StrobeState=0),joypadLastWrite=r):16407==a&&APU.writeReg(a,r):a>=24576&&a<32768&&fa.onBatteryRamWrite(a,r),a<32768&&(t[a]=r),mapper_write(a,r)};var s,m,l,u,_,y,b,T,k,v,d,U,R,j,E,H,L,W,G,z,M,J,K,Q,$,q,aa,ra,ea,ta,fa={loop:null,fps:60,frameTime:1e3/60,cpu_cycles:0,mapper:0,mirroring:0,prg:[],chr:[],frameCtx:null,vramCtx:null,frameData:null,vramData:null,frameBuffer:null,vramBuffer:null,frameBuffer8:null,vramBuffer8:null,frameBuffer32:null,vramBuffer32:null,leftSamples:[],rightSamples:[],currentSample:0,sampleRate:44100,cyclesToHalt:0,controllers:null,prg_0_bank:0,prg_1_bank:1,chr_bank:0,mirroring_backup:0,init:({rom:a,save:r,frame:t,vram:f,audio:c})=>{fa.reset(),fa.parse(a),fa.load(),fa.frameCtx=t.getContext("2d"),fa.frameData=fa.frameCtx.getImageData(0,0,256,240),fa.frameBuffer=new ArrayBuffer(245760),fa.vramBuffer=new ArrayBuffer(983040),fa.frameBuffer8=new Uint8Array(fa.frameBuffer),fa.frameBuffer32=new Uint32Array(fa.frameBuffer),f&&(fa.vramCtx=f.getContext("2d"),fa.vramData=fa.vramCtx.getImageData(0,0,512,480),fa.vramBuffer32=new Uint32Array(fa.vramBuffer),fa.vramBuffer8=new Uint8Array(fa.vramBuffer)),fa.controllers={1:new e,2:new e},onkeydown=onkeyup=a=>{fa[a.type](1,{37:e.BUTTON_LEFT,38:e.BUTTON_UP,39:e.BUTTON_RIGHT,40:e.BUTTON_DOWN,88:e.BUTTON_A,67:e.BUTTON_B,27:e.BUTTON_SELECT,13:e.BUTTON_START}[a.keyCode])}},play:()=>{fa.loop=setInterval(fa.frame,fa.frameTime)},pause:()=>{clearInterval(fa.loop)},reset:()=>{fa.pause(),t=[],pa(),APU.reset(),o=2,fa.cyclesToHalt=0},frame:()=>{var a;for(vramCanvas.width^=0,totalCycles=0,ta=0;!ta;)for(0===fa.cyclesToHalt?(o?(op(o),o=0):op(),a=c):fa.cyclesToHalt-=Math.min(fa.cyclesToHalt,8),i=a;i--;)n()},keydown:(a,r)=>{fa.controllers[a].keydown(r)},keyup:(a,r)=>{fa.controllers[a].keyup(r)},haltCycles:a=>{fa.cyclesToHalt+=a}},ca="777812a0090470810a00a007024040050130531000000000bbbe70e32f08b0b50e02d04c0780900a0390880111000000ffffb3f95f8af7fb7f67f39f3bf1d84d49f5de0333000000ffffeafdcfcdfcfdcfbbfadfaefafebfacfbff9888000000".match(/.../g).map((a=>+("0xff"+a[0]+a[0]+a[1]+a[1]+a[2]+a[2]))),pa=()=>{_=[],y=[],l=u=T=k=v=d=U=R=j=E=H=W=G=z=M=0,sa(0),ma(0)},oa=a=>((a&=16383)>16127?16144==(a&=16159)&&(a=16128):a>12287?a-=4096:a>8191&&(fa.mirroring<3?a&=14335+1024*fa.mirroring:3==fa.mirroring&&(a&=9215)),a),na=a=>a<8192?fa.chr[fa.chr_bank][a]:(16128==(65523&a)&&(a=16128),_[oa(a)]||0),sa=a=>{a>>7&1,J=a>>5&1,K=a>>4&1,Q=a>>3&1,$=a>>2&1,d=3&a},ma=a=>{q=a>>4&1,aa=a>>3&1},Ca=()=>(s=t[8194]=(W<<5)+(G<<6)+(z<<7),M=0,z=0,s),la=a=>{ra=a},ia=()=>y[ra],ua=a=>{y[ra]=a,ra++,ra%=256},Pa=a=>{M?(U=a>>3,v=7&a):(R=a>>3,j=7&a),M^=1},Aa=a=>{M?(ea+=a,v,U+=a>>5,k=R=31&a,T=d):(ea=a<<8,v=a>>4&3,d=a>>2&3,U=(3&a)<<3),M^=1},ga=a=>{ea<8192&&(fa.chr[fa.chr_bank][ea]=a),_[oa(ea)]=a,ea+=$?32:1},_a=()=>(ea<=16128?(s=L,L=na(ea)):s=na(ea),ea+=1===$?32:1,s),ya=a=>{for(var r=ra;r<256;r++)y[r]=t[256*a+r];for(r=0;r<513;r++)n();fa.haltCycles(513)},ba=a=>{var r,e,t,f,c;for(b=[],e=~~(a/8),r=64;r--;)for(f=na((t=8192+2048*(e>29)+1024*(r>31))+960+8*(e%30>>2)+(r%32>>2))>>4*(e%30>>1&1)+2*(r%32>>1&1)&3,a%=8,x=8;x--;)s=4096*K+16*na(t+e%30*32+r%32)+a,(c=2*(na(s+8)>>7-x&1)+(na(s)>>7-x&1))&&(b[8*r+x]=ca[na(16128+4*f+c)]),fa.vramBuffer32[512*(8*e+a)+(8*r+x)]=ca[na(16128+4*f+c)]},Ba=()=>{++u>340&&(u=0,l++,k=R,T=(2&T)+(1&d),l<240?(ba(((l+H)%480+240)%480),ba((l+H)%480),(a=>{var r,e,t,f,c,p;for(t=[],r=0;r<64;r++)if(a>=y[4*r]&&a<y[4*r]+(J?16:8)){if(8==t.length){W=1;break}t.push(r)}for(e=0;e<256;e++)for(aa&&(fa.frameBuffer32[256*a+e]=b[(e+E)%512]||ca[na(oa(16128))]),r=t.length-1;r>=0;r--)e>=y[4*t[r]+3]&&e<y[4*t[r]+3]+8&&(c=3&y[4*t[r]+2],s=4*t[r],m=y[s],f=4096*(J?1&y[s+1]:Q)+16*(y[s+1]&255-J)+(128&y[s+2]?7-a+m+8*((a<m+8&&J)+J):8+a-m-8*(a<m+8)),s=e-y[4*t[r]+3],m=64&y[4*t[r]+2]?s:7-s,(p=2*(na(f+8)>>m&1)+(na(f)>>m&1))&&(32&y[4*t[r]+2]&&b[(e+E)%512]&&aa||!q||(fa.frameBuffer32[256*a+e]=ca[_[16144+4*c+p]]),0===t[r]&&!G&&b[(e+E)%512]&&q&&aa&&(G=1)))})(l),E=256*(1&T)+8*k+j,fa.vramCtx.fillStyle="pink",fa.vramCtx.rect(E-2,(l+H-2)%480,0==l||239==l?256:4,4),fa.vramCtx.rect((E-2+256)%512,(l+H-2)%480,4,4)):240==l?(z=1,o=1,fa.frameData.data.set(fa.frameBuffer8),fa.frameCtx.putImageData(fa.frameData,0,0),fa.vramData.data.set(fa.vramBuffer8),fa.vramCtx.putImageData(fa.vramData,0,0),aa&&fa.vramCtx.fill()):260==l?W=G=z=0:261==l&&(l=-1,ta=1,H=240*((T=(1&T)+(2&d))>>1)+8*U+v))};fa.parse=(a,r,e,t)=>{if(a[0]+a[1]+a[2]+a[3]==256){for(fa.mirroring=8&a[6]?2:1&a[6]?0:1,fa.mapper=(a[6]>>4)+(240&a[7]),t=16,4&a[6]&&(t+=512),fa.prg=[],r=0;r<a[4];r++)for(fa.prg[r]=[],e=0;e<16384;e++)fa.prg[r][e]=a[t++];for(fa.chr=[[]],r=0;r<a[5];r++)for(fa.chr[r]=[],e=0;e<8192;e++)fa.chr[r][e]=a[t++]}};
fileInput.onchange = (fileReader) => {
  fileReader = new FileReader();
  fileReader.readAsArrayBuffer(fileInput.files[0]);
  fileReader.onload = () => {
    NES.init({rom: new Uint8Array(fileReader.result), frame: frameCanvas, vram: vramCanvas, audio});
    if(i_start.checked) NES.play();
  }
}
</script>